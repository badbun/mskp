// Ionic Starter App

// angular.module is a global place for creating, registering and retrieving Angular modules
// 'starter' is the name of this angular module example (also set in a <body> attribute in index.html)
// the 2nd parameter is an array of 'requires'
// 'starter.services' is found in services.js
// 'starter.controllers' is found in controllers.js
angular.module('mskp.consumer',['ionic']);
angular.module('mskp.merchant',['ionic']);

angular.module('mskp', ['ionic','mskp.consumer','mskp.merchant'])
    .controller('DefaultController', ['$rootScope','$scope', function ($rootScope,$scope) {}])

    .run(["$ionicPlatform", 'WxConfig', function ($ionicPlatform, WxConfig) {

        $ionicPlatform.ready(function () {
            // Hide the accessory bar by default (remove this to show the accessory bar above the keyboard
            // for form inputs)
            if (window.cordova && window.cordova.plugins && window.cordova.plugins.Keyboard) {
                cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);
                cordova.plugins.Keyboard.disableScroll(true);

        }
        if (window.StatusBar) {
          // org.apache.cordova.statusbar required
          StatusBar.styleDefault();
        }
      });
}]);

/**
 * Created by liliang on 2016/3/16.
 */
angular.module('mskp')
    .config(['$stateProvider','$urlRouterProvider',function($stateProvider, $urlRouterProvider) {
        //$stateProvider
        //    .state('default', {
        //        url: '/mskp/default',
        //        templateUrl: 'views/default.html',
        //        controller: 'DefaultController'
        //    })
            //.state('menu', {
            //    url: '/mskp/consumer',
            //    templateUrl: 'views/consumer/templates/index.html',
            //    controller: 'consumerController'
            //});
        //$urlRouterProvider.otherwise('/mskp/default');
    }]);


/**
 * Created by liliang on 2016/3/16.
 */
angular.module('mskp')
    .constant({
        mock: false
    })
    .factory('Host', ['mock', function (mock) {
        var host = [
            {
                hostname: 'MSKP',
                hosturl: 'http://hswywechat.servyou.com.cn/apps/',
                //hosturl: '../apps/',
                mockurl: '',
                descript: ''
            }
        ];
        return {
            all: function () {
                return host;
            },
            getByName: function (hostname) {
                for (var i = 0; i < host.length; i++) {
                    if (host[i].hostname === hostname) {
                        return host[i];
                    }
                }
                return null;
            },
            getHostByName: function (hostname) {
                var _host = this.getByName(hostname);
                if (_host != null) {
                    return mock ? _host.mockurl : _host.hosturl;
                }
                return null;
            }
        }
    }])
    .factory("UrlFilter", [function () {
        var urlList = {
            shareTitleInfo: "shareTitleInfo"
        };
        return {
            filter: function (url) {
                for (var a in urlList) {
                    if (url.indexOf(urlList[a]) > -1) {
                        return true;
                    }
                }
                return false;
            }
        }
    }])
    .factory('Url', ['mock', function (mock) {
        var url = [
            {
                urlname: 'WX',
                url: '/api/wechat/signature',
                mockurl: 'invoiceonmove/www/data/wxconfig.json',
                descript: '获取微信接口调用基本信息'
            },
            {
                urlname: 'openid',
                url: 'api/wechat/openid/',
                mockurl: 'api/wechat/openid/',
                descript: '获取微信openid'
            }
        ];
        return {
            all: function () {
                return url;
            },
            getByName: function (urlname) {
                for (var i = 0; i < url.length; i++) {
                    if (url[i].urlname === urlname) {
                        return url[i];
                    }
                }
                return null;
            },
            getUrlByName: function (urlname) {
                var _url = this.getByName(urlname);
                if (_url != null) {
                    return mock ? _url.mockurl : _url.url;
                }
                return null;
            }
        }
    }]).factory('storageUtil', [function () {
    return {
        cookie: {
            set: function (key, value, expiresHours) {
                var cookieString = key + "=" + escape(value);
                if (expiresHours && (parseInt(expiresHours) + "") != "NaN" && expiresHours > 0) {
                    var date = new Date();
                    date.setTime(date.getTime + expiresHours * 3600 * 1000);
                    cookieString = cookieString + "; expires=" + date.toGMTString();
                }
                document.cookie = cookieString;
            },
            get: function (key) {
                var strCookie = document.cookie;
                var arrCookie = strCookie.split("; ");
                for (var i = 0; i < arrCookie.length; i++) {
                    var arr = arrCookie[i].split("=");
                    if (arr[0] == key)
                        return arr[1];
                }
                return "";
            },
            remove: function (key) {
                var date = new Date();
                date.setTime(date.getTime() - 10000);
                document.cookie = key + "=v; expires=" + date.toGMTString();
            }
        },
        localData: {
            hostname: location.hostname ? location.hostname : 'localStatus',
            isLocalStorage: window.localStorage ? true : false,
            dataDom: null,
            initDom: function () { //初始化userData
                if (!this.dataDom) {
                    try {
                        this.dataDom = document.createElement('input');//这里使用hidden的input元素
                        this.dataDom.type = 'hidden';
                        this.dataDom.style.display = "none";
                        this.dataDom.addBehavior('#default#userData');//这是userData的语法
                        document.body.appendChild(this.dataDom);
                        var exDate = new Date();
                        exDate = exDate.getDate() + 30;
                        this.dataDom.expires = exDate.toUTCString();//设定过期时间
                    } catch (ex) {
                        return false;
                    }
                }
                return true;
            },
            set: function (key, value) {
                if (this.isLocalStorage) {
                    window.localStorage.setItem(key, value);
                } else {
                    if (this.initDom()) {
                        this.dataDom.load(this.hostname);
                        this.dataDom.setAttribute(key, value);
                        this.dataDom.save(this.hostname)
                    }
                }
            },
            get: function (key) {
                if (this.isLocalStorage) {
                    return window.localStorage.getItem(key);
                } else {
                    if (this.initDom()) {
                        this.dataDom.load(this.hostname);
                        return this.dataDom.getAttribute(key);
                    }
                }
            },
            remove: function (key) {
                if (this.isLocalStorage) {
                    localStorage.removeItem(key);
                } else {
                    if (this.initDom()) {
                        this.dataDom.load(this.hostname);
                        this.dataDom.removeAttribute(key);
                        this.dataDom.save(this.hostname)
                    }
                }
            }
        }
    }
}])
;

/**
 * Created by liliang on 2016/3/16.
 */
angular.module('mskp').factory('WxApi', [function () {
    return {
        //操作失败处理
        error: function (){
            wx.error(function(res){

            });
        },
        //分享给朋友
        shareToFriend: function (title,desc,link,imgUrl,succ) {
            wx.onMenuShareAppMessage({
                title: title, // 分享标题
                desc: desc,
                link: link,
                imgUrl: imgUrl,
                type: 'link', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function (data) {
                    succ(data);
                },
                cancel: function () {
                }
            });
        },
        //分享到朋友圈
        shareToCircle: function (title,link,imgUrl, succ) {
            wx.onMenuShareTimeline({
                title: title, // 分享标题
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                success: function () {
                    succ();
                },
                cancel: function () {
                }
            });
        },
        //网络类型
        networkType: function(succ){
            wx.getNetworkType({
                success: function (res) {
                    var networkType = res.networkType; // 返回网络类型2g，3g，4g，wifi
                    succ(networkType);
                }
            });
        },
        //打开某地理位置
        openLocation: function(param){
            var _param = param || {
                    latitude: 0, // 纬度，浮点数，范围为90 ~ -90
                    longitude: 0, // 经度，浮点数，范围为180 ~ -180。
                    name: '', // 位置名
                    address: '', // 地址详情说明
                    scale: 1, // 地图缩放级别,整形值,范围从1~28。默认为最大
                    infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
                };
            wx.openLocation(_param);
        },
        //获得某地理位置
        getLocation: function(succ){
            wx.getLocation({
                type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                success: function (res) {
                    var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                    var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                    var speed = res.speed; // 速度，以米/每秒计
                    var accuracy = res.accuracy; // 位置精度
                    succ(res);
                }
            });
        },
        //隐藏右上角菜单
        hideRightTopMenu: function(){
            wx.hideOptionMenu();
        },
        //显示右上角菜单
        showRightTopMenu: function(){
            wx.showOptionMenu();
        },
        //隐藏指定菜单
        hideMenus: function(list){
            wx.hideMenuItems({
                menuList: list // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
            });
        },
        //显示指定菜单
        showMenus: function(list){
            wx.showMenuItems({
                menuList: list // 要显示的菜单项，所有menu项见附录3
            });
        },
        //关闭页面
        closePage: function(){
            wx.closeWindow();
        },
        //隐藏所有非基础菜单
        hideAllMenus: function(){
            wx.hideAllNonBaseMenuItem();
        },
        //显示所有非基础菜单
        showAllMenus: function(){
            wx.showAllNonBaseMenuItem();
        },
        //扫描
        scan: function(needResult,scanType, succ){
            wx.scanQRCode({
                needResult: needResult, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                scanType: scanType, // 可以指定扫二维码还是一维码，默认二者都有["qrCode","barCode"]
                success: function (res) {
                    var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                    succ(result);
                }
            });
        }
    }
}]).factory('WxConfig', ['$ionicLoading', '$http', 'Host', 'Url', '$location',
    'storageUtil', 'UrlFilter','WxApi',
    function ($ionicLoading, $http, Host, Url, $location, storageUtil, UrlFilter, WxApi) {
        var wxConfig = {
            isFinished: false,
            debug: false,
            appId: '', // 必填，公众号的唯一标识
            timestamp: '', // 必填，生成签名的时间戳
            nonceStr: '', // 必填，生成签名的随机串
            signature: '',// 必填，签名，见附录1
            jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'hideOptionMenu', 'showOptionMenu',
                'closeWindow', 'hideMenuItems', 'showMenuItems', 'hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem',
                'scanQRCode', 'getNetworkType', 'openLocation', 'getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        }
        var isInit = false;
        var code = null, apiList, apiNum = 0;
        var _self =  {
            init: function () {
                if (!UrlFilter.filter(window.location.href)) {
                    $ionicLoading.show({
                        content: '正在加载......',
                        animation: 'fade-in',
                        showBackdrop: true,
                        maxWidth: 400,
                        showDelay: 0
                    });
                    var self = this;
                    if (!isInit) {
                        var url = window.location.href;
                        $http({
                            method: "post",
                            url: Host.getHostByName("MSKP") + Url.getUrlByName("WX"),
                            data: {url: url.split("#")[0], code: this.getCode()}
                        }).success(function (data) {
                            isInit = true;
                            wxConfig.appId = data.data.appId;
                            wxConfig.timestamp = data.data.timestamp;
                            wxConfig.nonceStr = data.data.nonceStr;
                            wxConfig.signature = data.data.signature;
                            wxConfig.isFinished = true;

                            if(!self.getOpenid()){
                                storageUtil.localData.set("openId", data.datakz.openid);
                                window.location.reload();
                            }else{
                                storageUtil.localData.set("openId", data.datakz.openid);
                            }

                            //初始化微信接口配置
                            wx.config(wxConfig);
                            wx.ready(function () {
                                self.loaded();
                                self.doWechatApi();
                            });
                            self.doWechatApi();
                        });
                    }
                }
            },

            config: function () {
                return wxConfig;
            },
            getOpenid: function () {
                return storageUtil.localData.get("openId");
            },
            getCode: function () {
                if (!code) {
                    code = this.urlSearch("code");
                }
                return code;
            },
            loaded: function () {
                $ionicLoading.hide();
                console.log("wechat api is ready!");
            },
            urlSearch: function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg) || window.location.href.split("?")[1].match(reg);
                if (r != null) return unescape(r[2]);
                return "";
            },
            onWechatReady: function(apis){
                apiList = apiList || {};
                for(var i=0; i<apis.length;i++){
                    apiList[i+apiNum] = apis[i];
                }
                apiNum += apis.length;
                console.log(apiList);
            },
            doWechatApi: function(){
                for(var api in apiList){
                    if(typeof apiList[api] == "object"){
                        for(var a in apiList[api]){
                            WxApi[a].apply(this,apiList[api][a]);
                            console.log("executed api: "+a);
                        }
                    }
                    if(typeof apiList[api] == "string"){
                        WxApi[apiList[api]]();
                        console.log("executed api: "+apiList[api]);
                    }
                }
            }
        }
        _self.init();
        return _self;

    }])
;

/**
 * Created by fengpc on 2016-5-23.
 */
angular.module('mskp.consumer')
    .config(['$stateProvider',function($stateProvider) {
        $stateProvider
            .state('consumer', {
                url: '/mskp/consumer',
                cache:'false',
                templateUrl: 'views/consumer/templates/index.html',
                controller: 'consumerController'
            })
            .state('invoiceTitleInfo', {
                url: '/mskp/invoiceTitleInfo',
                templateUrl: 'views/consumer/templates/invoice-title-info.html',
                controller: 'titleInfoController'
            })
            .state('addInvoiceTitle', {
                url: '/mskp/addInvoiceTitle',
                templateUrl: 'views/consumer/templates/add-invoice-title.html',
                controller: 'addTitleController'
            })
            .state('editInvoiceTitle', {
                url: '/mskp/editInvoiceTitle',
                templateUrl: 'views/consumer/templates/add-invoice-title.html',
                controller: 'titleInfoController'
            })
            .state('shareTitleInfo', {
                url: '/mskp/shareTitleInfo',
                templateUrl: 'views/consumer/templates/share-title-info.html',
                controller: 'shareController'
            })
    }]);

/**
 * Created by fengpc on 2016-5-25.
 */
angular.module('mskp.consumer')
    .service('consumerService', ['Host', function (Host) {

        var _BaseUrl = Host.getHostByName('MSKP');
        //var _BaseUrl = 'http://192.168.31.7:8081/qyfwpt'

        this.baseUrl = _BaseUrl;
        this.allInvoiceTitleUrl = _BaseUrl + '/api/mskp/ttxx/queryttxxList';
        this.singleTitleUrl = _BaseUrl + '/api/mskp/ttxx/queryttxx';
        this.saveTitleUrl = _BaseUrl + '/api/mskp/ttxx/savettxx';
        this.deleteTitleUrl = _BaseUrl + '/api/mskp/ttxx/delttxx';
        this.ewmUrl = _BaseUrl + '/api/mskp/ttxx/getPic';
        this.openidUrl = _BaseUrl + 'api/wechat/openid/';

        this.wxid = '';
    }])
    .factory('consumerFactory', ['$ionicPopup',function ($ionicPopup) {
        return {
            titleInfo: {},
            showAlert: function (prompt) {
                $ionicPopup.alert({
                    content: prompt,
                    okText: '确定'
                }).then(function (res) {
                })
            }
        }
    }])

/**
 * Created by fengpc on 2016-5-24.
 */
angular.module('mskp.merchant')
    .config(['$stateProvider',function($stateProvider) {
        $stateProvider
            .state('bindingBM', {
                url: '/mskp/bindingBM',
                templateUrl: 'views/merchant/templates/binding-BM.html',
                controller: 'bindingBMController'
            })
            .state('scanConsumerTilte', {
                url: '/mskp/scanConsumerTilte',
                templateUrl: 'views/merchant/templates/scan-result.html',
                controller: 'scanTitleController'
            })
            .state('downloadLink', {
                url: '/mskp/downloadLink',
                templateUrl: 'views/merchant/templates/download-link.html'
            })
    }]);

/**
 * Created by fengpc on 2016-5-27.
 */
angular.module('mskp.merchant')
    .service('merchantService',['Host',function(Host) {

        var _BaseUrl = Host.getHostByName('MSKP');
        //var _BaseUrl = 'http://192.168.31.7:8081/qyfwpt'
        this.baseUrl = _BaseUrl;
        this.openidUrl = _BaseUrl  + 'api/wechat/openid/';
        this.kpjxxUrl = _BaseUrl +  '/api/mskp/kpjxx/queryKpjxxBywxid';
        this.bindingBMUrl = _BaseUrl + '/api/mskp/kpkc/weixinScan';
        this.savekpxxUrl = _BaseUrl + '/api/mskp/kpjxx/savekpxx';

        this.wxid = '';
    }])
    .factory('merchantFactory',[function() {
        return {
            kpjxx:{},
            showAlert: function (prompt) {
                $ionicPopup.alert({
                    content: prompt,
                    okText: '确定'
                }).then(function (res) {
                })
            }
        }
    }])

/**
 * Created by fengpc on 2016-5-25.
 */
angular
    .module('mskp')
    .controller('addTitleController', ['$scope','$state','$http','consumerService','consumerFactory','WxConfig',
        function ($scope,$state,$http,consumerService,consumerFactory,WxConfig) {
            $scope.viewTitle = "添加发票抬头";
            $scope.isShowybnsrInfo = false;
            $scope.titleInfo ={
                    wxid:'',
                    wxmc:'',
                    xh:0,
                    zzszpbz:false,
                    mrttbz:true,
                    kpm:'',
                    nsrmc:'',
                    nsrsbh:'',
                    khh:'',
                    lxdh:'',
                    "dz":'',
                    yhzh:''
            }

            $scope.showYbnsrInfo = function () {
                $scope.isShowybnsrInfo = !$scope.isShowybnsrInfo;
                if($scope.isShowybnsrInfo)
                    $scope.titleInfo.zzszpbz = true;
                else
                    $scope.titleInfo.zzszpbz = false;
            }

            $scope.saveTitleInfo = function(){
                if($scope.titleInfo.nsrmc == ''){
                    consumerFactory.showAlert('请输入公司名称！');
                    return;
                }
                if($scope.isShowybnsrInfo && $scope.titleInfo.zzszpbz){
                    if($scope.titleInfo.nsrsbh == ''){
                        consumerFactory.showAlert('请输入税号！');
                        return;
                    }
                    if($scope.titleInfo.dz == ''){
                        consumerFactory.showAlert('请输入地址！');
                        return;
                    }
                    if($scope.titleInfo.dh == ''){
                        consumerFactory.showAlert('请输入地址！');
                        return;
                    }
                    if($scope.titleInfo.khh == ''){
                        consumerFactory.showAlert('请输入开户行！');
                        return;
                    }
                    if($scope.titleInfo.yhzh == ''){
                        consumerFactory.showAlert('请输入账号！');
                        return;
                    }
                    //if(($scope.titleInfo.nsrsbh == '')||($scope.titleInfo.dz == '')||($scope.titleInfo.dh == '')||
                    //    ($scope.titleInfo.khh == '')||($scope.titleInfo.yhzh == '')){
                    //        return;
                    //}
                }
                $http({
                    method: "post",
                    url: consumerService.saveTitleUrl,
                    data: {
                        wxid: WxConfig.getOpenid(),
                        wxmc:"",
                        zzszpbz:($scope.titleInfo.zzszpbz?"Y":"N"),
                        mrttbz:($scope.titleInfo.mrttbz?"Y":"N"),
                        kpm:"",
                        nsrmc:$scope.titleInfo.nsrmc,
                        nsrsbh:$scope.titleInfo.nsrsbh,
                        khh:$scope.titleInfo.khh,
                        lxdh:$scope.titleInfo.lxdh,
                        dz:$scope.titleInfo.dz,
                        yhzh:$scope.titleInfo.yhzh,
                        xh:$scope.titleInfo.xh,
                        bclx:"C"
                    }
                }).success(function (data, status) {
                    console.log(data);
                    $state.go('consumer');
                }).error(function (data, status) {
                    console.log('error');
                });
            }
        }
    ]);


angular
    .module('mskp')
    .controller('consumerController', ['$scope','$state', '$http','$location','$ionicSlideBoxDelegate','$ionicHistory','$ionicPopup',
        'consumerService','consumerFactory','WxConfig','WxApi',
        function ($scope,$state,$http,$location, $ionicSlideBoxDelegate,$ionicHistory,$ionicPopup,consumerService,consumerFactory,WxConfig,WxApi) {
            WxConfig.onWechatReady(['hideRightTopMenu']);
            $scope.titleInfoList = [];
            consumerFactory.titleInfo = [];
            $scope.titleShowView = 'defualt';
            $ionicHistory.clearHistory();
            var allInvoiceTitleRequest = function(){
                $scope.titleShowView = 'defualt';
                $http({
                    method: "post",
                    url: consumerService.allInvoiceTitleUrl,
                    data: {"wxid":WxConfig.getOpenid()}
                }).success(function (data, status) {
                    if(data.returnCode == '00000000') {
                        $scope.titleInfoList = data.data;

                        if($scope.titleInfoList == ''){
                            $scope.titleShowView = 'noTitle';
                            return;
                        }
                        for (i = 0; i < $scope.titleInfoList.length; i++) {
                            $scope.titleInfoList[i].ewmUrl = consumerService.ewmUrl + '?wxid=' + WxConfig.getOpenid() +
                                '&nsrmc=' + $scope.titleInfoList[i].nsrmc;
                        }
                        $scope.titleShowView = 'hadTitle';
                    }
                    $ionicSlideBoxDelegate.update();
                }).error(function (data, status) {
                    $scope.titleShowView = 'defualt';
                    console.log('error');
                });
            }
            var deleteTitleRequest = function(xh){
                $http({
                    method: "post",
                    url: consumerService.deleteTitleUrl,
                    data: {
                        wxid: WxConfig.getOpenid(),
                        xh:xh
                    }
                }).success(function (data, status) {
                    allInvoiceTitleRequest();          //删除成功，重新加载发票抬头
                }).error(function (data, status) {
                    console.log('error');
                });
            }

            $scope.showTitleInfo = function(xh){
                for( i = 0;i<$scope.titleInfoList.length;i++){
                    if($scope.titleInfoList[i].xh == xh){
                        consumerFactory.titleInfo = $scope.titleInfoList[i];
                        if(consumerFactory.titleInfo.mrttbz == 'Y')
                            consumerFactory.titleInfo.mrttbz = true;
                        else
                            consumerFactory.titleInfo.mrttbz = false;
                        console.log(consumerFactory.titleInfo);
                        $state.go('invoiceTitleInfo');
                        break;
                    }
                }
            }
            $scope.editTitleInfo = function(xh){
                for( i = 0;i<$scope.titleInfoList.length;i++){
                    if($scope.titleInfoList[i].xh == xh){
                        consumerFactory.titleInfo = $scope.titleInfoList[i];

                        if(consumerFactory.titleInfo.mrttbz == 'Y')
                            consumerFactory.titleInfo.mrttbz = true;
                        else
                            consumerFactory.titleInfo.mrttbz = false;
                        if(consumerFactory.titleInfo.zzszpbz == 'Y')
                            consumerFactory.titleInfo.zzszpbz = true;
                        else
                            consumerFactory.titleInfo.zzszpbz = false;

                        $state.go('editInvoiceTitle');
                        break;
                    }
                }
            }
            $scope.deleteTitleInfo = function(xh){
                $ionicPopup.confirm({
                    content: '确定要删除么？',
                    cancelText:'取消',
                    okText:'确定'
                }).then(function (res) {
                    if (res) {
                        deleteTitleRequest(xh);
                    } else {
                    }
                });
            }

            $scope.invoiceTitleShare = function(){
                WxApi.showRightTopMenu();
                var titleInfo = $scope.titleInfoList[$ionicSlideBoxDelegate.currentIndex()];
                var data = {
                    nsrmc:titleInfo.nsrmc,
                    nsrsbh:titleInfo.nsrsbh,
                    dz:titleInfo.dz,
                    dh:titleInfo.dh,
                    khh:titleInfo.khh,
                    yhzh:titleInfo.yhzh,
                    fplx:titleInfo.fplx
                };
                var param = "?";
                for(var a in data){
                    param+=a+"="+data[a]+"&";
                }

                var title = '发票抬头';
                var desc = 'desc';
                var link = 'http://hswywechat.servyou.com.cn/wechat/index.html#/mskp/shareTitleInfo'+param;
                var imgUrl = '';

                //分享给朋友
                WxApi.shareToFriend(title,desc,link,imgUrl,function(data){
                    alert(data.data);
                });
                console.log('share');
            }

            $scope.slideBoxBack = function () {
                var slidesCount = $ionicSlideBoxDelegate.slidesCount() - 1;
                if ($ionicSlideBoxDelegate.currentIndex() != 0)
                    $ionicSlideBoxDelegate.previous();
                else
                    $ionicSlideBoxDelegate.slide(slidesCount);
            }
            $scope.slideBoxNext = function () {
                var slidesCount = $ionicSlideBoxDelegate.slidesCount() - 1;
                if (slidesCount != $ionicSlideBoxDelegate.currentIndex())
                    $ionicSlideBoxDelegate.next();
                else
                    $ionicSlideBoxDelegate.slide(0);
            }

            //首页请求
            allInvoiceTitleRequest();
        }
    ]);

/**
 * Created by fengpc on 2016-5-26.
 */
angular
    .module('mskp')
    .controller('shareController', ['$scope', '$location','$http','consumerService',
        function ($scope,$location,$http,consumerService) {
            $scope.titleInfo ={
                wxid:'',
                wxmc:'',
                xh:0,
                zzszpbz:false,
                mrttbz:true,
                kpm:'',
                nsrmc:'',
                nsrsbh:'',
                khh:'',
                lxdh:'',
                "dz":'',
                yhzh:''
            }
            console.log($location.search());
            alert($location.search().nsrmc);
            $scope.titleInfo.nsrmc = $location.search().nsrmc;
            $scope.titleInfo.nsrsbh = $location.search().nsrsbh;
            $scope.titleInfo.dz = $location.search().dz;
            $scope.titleInfo.lxdh = $location.search().lxdh;
            $scope.titleInfo.khh = $location.search().khh;
            $scope.titleInfo.yhzh = $location.search().yhzh;

            //var singleTitleRequest = function () {
            //    console.log(consumerService.singleTitleUrl);
            //    $http({
            //        method: "post",
            //        url: consumerService.singleTitleUrl,
            //        data: {
            //            "wxid": $stateParams.wxid,
            //            "nsrsbh":$stateParams.nsrsbh
            //        }
            //    }).success(function (data, status) {
            //        $scope.titleInfo = data.data;
            //        console.log(data);
            //    }).error(function (data, status) {
            //        console.log('error');
            //    });
            //}
            //singleTitleRequest();

            $scope.saveTitleToMine = function () {
                console.log('saveTitleToMine');
            }
        }
    ]);

/**
 * Created by fengpc on 2016-5-25.
 */
angular
    .module('mskp')
    .controller('titleInfoController', ['$scope', '$state', '$http', 'consumerService', 'consumerFactory', 'WxConfig',
        function ($scope, $state, $http, consumerService, consumerFactory, WxConfig) {
            $scope.viewTitle = "编辑发票抬头";
            $scope.isShowybnsrInfo = true;
            $scope.titleInfo = consumerFactory.titleInfo;

            $scope.showYbnsrInfo = function () {
                $scope.isShowybnsrInfo = !$scope.isShowybnsrInfo;
            }

            $scope.invoiceTitleShare = function () {
                console.log('share');
            }
            $scope.saveTitleInfo = function () {
                //if($scope.titleInfo.nsrmc == ''){
                //    return;
                //}
                //if($scope.isShowybnsrInfo && $scope.titleInfo.zzszpbz){
                //    if(($scope.titleInfo.nsrsbh == '')||($scope.titleInfo.dz == '')||($scope.titleInfo.dh == '')||
                //        ($scope.titleInfo.khh == '')||($scope.titleInfo.yhzh == '')){
                //        return;
                //    }
                //}
                if ($scope.titleInfo.nsrmc == '') {
                    consumerFactory.showAlert('请输入公司名称！');
                    return;
                }
                if ($scope.isShowybnsrInfo && $scope.titleInfo.zzszpbz) {
                    if ($scope.titleInfo.nsrsbh == '') {
                        consumerFactory.showAlert('请输入税号！');
                        return;
                    }
                    if ($scope.titleInfo.dz == '') {
                        consumerFactory.showAlert('请输入地址！');
                        return;
                    }
                    if ($scope.titleInfo.dh == '') {
                        consumerFactory.showAlert('请输入地址！');
                        return;
                    }
                    if ($scope.titleInfo.khh == '') {
                        consumerFactory.showAlert('请输入开户行！');
                        return;
                    }
                    if ($scope.titleInfo.yhzh == '') {
                        consumerFactory.showAlert('请输入账号！');
                        return;
                    }
                }
                //发送保存请求
                $http({
                    method: "post",
                    url: consumerService.saveTitleUrl,
                    data: {
                        wxid: WxConfig.getOpenid(),
                        wxmc: "",
                        zzszpbz: ($scope.titleInfo.zzszpbz ? "Y" : "N"),
                        mrttbz: ($scope.titleInfo.mrttbz ? "Y" : "N"),
                        kpm: "",
                        nsrmc: $scope.titleInfo.nsrmc,
                        nsrsbh: $scope.titleInfo.nsrsbh,
                        khh: $scope.titleInfo.khh,
                        lxdh: $scope.titleInfo.lxdh,
                        dz: $scope.titleInfo.dz,
                        yhzh: $scope.titleInfo.yhzh,
                        xh: $scope.titleInfo.xh,
                        bclx: "U"
                    }
                }).success(function (data, status) {
                    $state.go('consumer');
                }).error(function (data, status) {
                    console.log('error');
                });
            }
        }
    ]);


/**
 * Created by fengpc on 2016-5-26.
 */
angular
    .module('mskp')
    .controller('bindingBMController', ['$scope','$location', '$http', 'merchantService', 'merchantFactory','WxApi','WxConfig',
        function ($scope,$location, $http, merchantService, merchantFactory,WxApi,WxConfig) {
            WxConfig.onWechatReady([{test:"123"},{test:"456"},{test:function(){alert(123);}}]);
            WxConfig.onWechatReady(["asd","wewe","e4r"]);
            $scope.kpjxx = {};
            $scope.BMShowView = 'default';

            //获取当前绑定开票机信息
            var getBMxxRequest = function() {
                $http({
                    method: "post",
                    url: merchantService.kpjxxUrl,
                    data: {"wxid": WxConfig.getOpenid()}
                }).success(function (data, status) {
                    if(data.returnCode == '00000000') {
                        $scope.BMShowView = 'hadBM';
                        $scope.kpjxx = data.data;
                    }else{
                        $scope.BMShowView = 'noBM';
                    }
                }).error(function (data, status) {
                    console.log('error');
                });
            }

            getBMxxRequest();

            //绑定开票机扫描
            $scope.BindingBMScan = function(){
                WxApi.scan(1,["qrCode"], function(data){
                    //判断二维码信息里是否含有bandId

                    if (data.indexOf('bandId') < 0) {
                        merchantFactory.showAlert("无法正确识别二维码！")
                        return ;
                    }
                    var bandId = data.split('=')[1];
                    bandId = bandId.substr(0,bandId.length-1);
                    if(bandId != ''){
                        $http({
                            method: "post",
                            url: merchantService.bindingBMUrl,
                            data: {
                                "wxid": WxConfig.getOpenid(),
                                "bandId":bandId
                            }
                        }).success(function (data, status) {
                            if(data.returnCode == '00000000') {
                                $scope.BMShowView = 'hadBM';
                                $scope.kpjxx = data.data;
                            }else{
                                $scope.BMShowView = 'noBM';
                            }
                        }).error(function (data, status) {
                            merhantFactory.showAlert(data);
                        });
                    }else{
                        merchantFactory.showAlert('二维码信息有误！');
                    }
                });
            }
        }]);

angular
    .module('mskp')
    .controller('scanTitleController', ['$scope', '$http', 'merchantService', 'merchantFactory', 'WxApi', 'WxConfig',
        function ($scope, $http, merchantService, merchantFactory, WxApi, WxConfig) {
            $scope.titleInfo = {}
            $scope.scanResult = "defualt";

            $scope.scanEwm = function () {
                $scope.titleInfo = {};
                WxApi.scan(1, ["qrCode"], function (data) {
                    var ewmInfo = JSON.parse(data);

                    if (ewmInfo.ghfwxid == '') {
                        $scope.scanResult = "false";
                        return;
                    }

                    //将扫描成功后的二维码信息发送到服务器
                    $http({
                        method: "post",
                        url: merchantService.savekpxxUrl,
                        data: {
                            "wxid": WxConfig.getOpenid(),
                            "ghfwxid": ewmInfo.ghfwxid,
                            "fplx": ewmInfo.fplx,
                            "xh": ewmInfo.xh
                        }
                    }).success(function (data, status) {
                        alert(data.returnCode);
                        if (data.returnCode = '00000000') {
                            $scope.scanResult = "success";
                            $scope.titleInfo = ewmInfo;
                        }
                        else {
                            $scope.scanResult = "false";
                        }
                    }).error(function (data, status) {
                        merhantFactory.showAlert(data);
                    });
                });
            }

            var getBMxxRequest = function () {
                $http({
                    method: "post",
                    url: merchantService.kpjxxUrl,
                    data: {"wxid": WxConfig.getOpenid()}
                }).success(function (data, status) {
                    if (data.returnCode == '00000000') {
                        $scope.scanResult = "scanResult";
                        //$scope.scanEwm();
                    } else {
                        $scope.scanResult = "noBinding";
                    }
                }).error(function (data, status) {
                    merhantFactory.showAlert(data);
                });
            }

            getBMxxRequest();

            //发票抬头扫描
            $scope.InvoiceTitleScan = function () {
                $scope.scanEwm();
            }
        }
    ]);
